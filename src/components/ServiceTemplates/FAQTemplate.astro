---
interface FAQItem {
  question: string;
  answer: string;
}

interface Props {
  fragen?: FAQItem[];
  title?: string;
  sectionId?: string;
}

const {
  fragen = [],
  title = 'FAQ - HÃ¤ufig gestellte Fragen',
  sectionId = 'faq',
} = Astro.props;

// Split fragen into two columns (first half and second half)
const midpoint = Math.ceil(fragen.length / 2);
const firstColumn = fragen.slice(0, midpoint);
const secondColumn = fragen.slice(midpoint);
---

<section id={sectionId} class="pb-32">
  <svg
    class="cs-wave -mb-16"
    width="1920"
    height="167"
    viewBox="0 0 1920 167"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M1920 167H0V0C111.116 45.3334 456.485 136 951 136C1445.52 136 1803.21 45.3334 1920 0V167Z"
      fill="white"
    >
    </path>
  </svg>
  <svg
    class="cs-wave mt-12 rotate-180"
    width="1920"
    height="167"
    viewBox="0 0 1920 167"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M1920 167H0V0C111.116 45.3334 456.485 136 951 136C1445.52 136 1803.21 45.3334 1920 0V167Z"
      fill="white"
    >
    </path>
  </svg>
  <div class="bg-base-100 mx-auto w-full max-w-screen-xl rounded-2xl pb-16">
    <div>
      <h2 class="mx-auto pb-16 text-center text-3xl font-bold">{title}</h2>
    </div>

    <div class="flex flex-col gap-6 md:flex-row">
      <div class="flex w-full flex-col gap-6 overflow-hidden">
        {
          firstColumn.map((frage, index) => {
            const faqIndex = index + 1;
            const buttonId = `faq-btn-${faqIndex}`;
            const contentId = `faq-content-${faqIndex}`;
            const textAlignClass = index === 0 ? 'text-justify' : '';

            return (
              <div class="faq-card hover:bg-primary/10 flex flex-col items-start justify-start rounded-lg border border-slate-200 bg-white p-3 hover:cursor-pointer">
                <button
                  type="button"
                  aria-disabled="false"
                  class="faq-button group flex h-auto w-full min-w-[38px] items-center justify-between gap-2 overflow-hidden rounded-lg stroke-slate-500 p-0 text-left align-middle text-sm leading-tight font-semibold whitespace-pre-wrap text-black transition-all duration-300 ease-in-out hover:cursor-pointer hover:opacity-80 disabled:cursor-not-allowed disabled:stroke-slate-400 disabled:text-slate-400"
                  id={buttonId}
                  aria-expanded="false"
                  aria-controls={contentId}
                >
                  <div>
                    <div class="flex w-full items-center justify-start gap-2">
                      <p class="md:text-md w-full text-base font-medium">{frage.question}</p>
                    </div>
                  </div>
                  <div class="size-5">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 20 20"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="stroke-black transition-transform duration-300 ease-in-out"
                    >
                      <path d="M5.83325 8.33325L9.99992 12.4999L14.1666 8.33325" />
                    </svg>
                  </div>
                </button>
                <div
                  id={contentId}
                  role="region"
                  aria-hidden="true"
                  aria-labelledby={buttonId}
                  class={`grid w-full grid-rows-[0fr] ${textAlignClass} text-xs text-slate-600 opacity-0 transition-[grid-template-rows,opacity] duration-300 ease-out md:pr-7`}
                >
                  <div class="overflow-hidden">
                    <p class="text-sm/relaxed text-pretty text-black" set:html={frage.answer} />
                  </div>
                </div>
              </div>
            );
          })
        }
      </div>

      <div class="flex w-full flex-col gap-6 overflow-hidden">
        {
          secondColumn.map((frage, index) => {
            const faqIndex = firstColumn.length + index + 1;
            const buttonId = `faq-btn-${faqIndex}`;
            const contentId = `faq-content-${faqIndex}`;
            const textAlignClass = index === 0 ? 'text-justify' : '';

            return (
              <div class="faq-card hover:bg-primary/10 flex flex-col items-start justify-start rounded-lg border border-slate-200 bg-white p-3 hover:cursor-pointer">
                <button
                  type="button"
                  aria-disabled="false"
                  class="faq-button group flex h-auto w-full min-w-[38px] items-center justify-between gap-2 overflow-hidden rounded-lg stroke-slate-500 p-0 text-left align-middle text-sm leading-tight font-semibold whitespace-pre-wrap text-black transition-all duration-300 ease-in-out hover:cursor-pointer hover:opacity-80 disabled:cursor-not-allowed disabled:stroke-slate-400 disabled:text-slate-400"
                  id={buttonId}
                  aria-expanded="false"
                  aria-controls={contentId}
                >
                  <div>
                    <div class="flex w-full items-center justify-start gap-2">
                      <p class="md:text-md w-full text-base font-medium">{frage.question}</p>
                    </div>
                  </div>
                  <div class="size-5">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 20 20"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="stroke-black transition-transform duration-300 ease-in-out"
                    >
                      <path d="M5.83325 8.33325L9.99992 12.4999L14.1666 8.33325" />
                    </svg>
                  </div>
                </button>
                <div
                  id={contentId}
                  role="region"
                  aria-hidden="true"
                  aria-labelledby={buttonId}
                  class={`grid w-full grid-rows-[0fr] ${textAlignClass} text-xs text-slate-600 opacity-0 transition-[grid-template-rows,opacity] duration-300 ease-out md:pr-7`}
                >
                  <div class="overflow-hidden">
                    <p class="text-sm/relaxed text-pretty text-black" set:html={frage.answer} />
                  </div>
                </div>
              </div>
            );
          })
        }
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Find all accordion buttons
    const accordionButtons = document.querySelectorAll<HTMLElement>('[aria-controls]');

    // Function to synchronize button heights for closed cards
    const synchronizeButtonHeights = () => {
      const closedButtons = Array.from(accordionButtons).filter(
        (btn) => btn.getAttribute('aria-expanded') === 'false'
      ) as HTMLElement[];

      if (closedButtons.length === 0) return;

      // Reset heights to auto to get natural height
      closedButtons.forEach((btn) => {
        btn.style.minHeight = 'auto';
      });

      // Get the maximum height
      const maxHeight = Math.max(...closedButtons.map((btn) => btn.offsetHeight));

      // Set all closed buttons to the same height
      closedButtons.forEach((btn) => {
        btn.style.minHeight = `${maxHeight}px`;
      });
    };

    accordionButtons.forEach((button) => {
      const contentId = button.getAttribute('aria-controls');
      if (!contentId) return;

      const content = document.getElementById(contentId);
      if (!content) return;

      // Function to toggle accordion
      const toggleAccordion = () => {
        const isExpanded = button.getAttribute('aria-expanded') === 'true';
        const icon = button.querySelector('svg');

        if (isExpanded) {
          // Close accordion
          button.setAttribute('aria-expanded', 'false');
          content.setAttribute('aria-hidden', 'true');
          content.classList.remove('grid-rows-[1fr]', 'opacity-100');
          content.classList.add('grid-rows-[0fr]', 'opacity-0');
          if (icon) {
            icon.classList.remove('rotate-180');
          }
          // Reset button height and synchronize closed buttons
          button.style.minHeight = 'auto';
          setTimeout(synchronizeButtonHeights, 50);
        } else {
          // Open accordion - remove height constraint on this button
          button.style.minHeight = 'auto';
          button.setAttribute('aria-expanded', 'true');
          content.setAttribute('aria-hidden', 'false');
          content.classList.remove('grid-rows-[0fr]', 'opacity-0');
          content.classList.add('grid-rows-[1fr]', 'opacity-100');
          if (icon) {
            icon.classList.add('rotate-180');
          }
          // Synchronize remaining closed buttons
          setTimeout(synchronizeButtonHeights, 50);
        }
      };

      // Add click listener to button
      button.addEventListener('click', toggleAccordion);

      // Add click listener to content area - only close when expanded
      content.addEventListener('click', (e) => {
        if (button.getAttribute('aria-expanded') === 'true') {
          toggleAccordion();
        }
      });
    });

    // Initial synchronization
    synchronizeButtonHeights();

    // Also synchronize on window resize
    let resizeTimeout: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('resize', () => {
      if (resizeTimeout) clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(synchronizeButtonHeights, 100);
    });
  });
</script>
